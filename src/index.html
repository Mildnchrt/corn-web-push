<!DOCTYPE html>
<html>
  <head>
  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
  <link rel="manifest" href="/manifest.json" />
    <!-- <script type="text/javascript" src="https://l2.io/ip.js?var=storeid"></script> -->
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async=""></script>
    <script>
    var storeid = '1'
    var OneSignal = window.OneSignal || []
    console.log(storeid)
    OneSignal.push(function() {
      OneSignal.init({
        appId: '17056444-a80b-40d4-9388-1a9a751b0f31',
        autoRegister: false,
        welcomeNotification: {
          'title': 'Wellcome to Sellsuki',
          'message': 'Thanks for subscribing!',
        },
        notifyButton: {
          enable: false,
          displayPredicate: function() {
            return OneSignal.isPushNotificationsEnabled()
            .then(function (isPushEnabled) {
            return !isPushEnabled
            })
          },
          showCredit: false,
          size: 'large'
        }
      })
    })

    async function onManageWebPushSubscriptionButtonClicked () {
      getSubscriptionState().then(function (state) {
        if (state.isPushEnabled) {
          checkStoreIdHaveAlready ()
        } else {
          OneSignal.registerForPushNotifications()
          OneSignal.setSubscription(true)
          console.log('http pop up && subscibe already')
        }
      })
    }  

    async function getSubscriptionState () {
      return Promise.all([
        OneSignal.isPushNotificationsEnabled(),
        OneSignal.isOptedOut()
      ])
      .then(function (result) {
        var isPushEnabled = result[0]
        var isOptedOut = result[1]
        return {
          isPushEnabled: isPushEnabled,
          isOptedOut: isOptedOut
        }
      })
    }
            
    function subscribe () {
      OneSignal.push(async function () {
        if (!OneSignal.isPushNotificationsSupported()) {
          return
        }
        onManageWebPushSubscriptionButtonClicked()
        OneSignal.on("subscriptionChange", function (isSubscribed) {
          onManageWebPushSubscriptionButtonClicked()
        })
        
      })
    }

    function corn () {
      httpGet('http://localhost:8005/api/webPushNotification/corn')
    }
    async function checkStoreIdHaveAlready () {
      OneSignal.push(function () {
        OneSignal.getUserId(function (playerIdCurrent) {
          console.log('playerid from Onesignal : ',playerIdCurrent)
          if (playerIdCurrent !== null) {
            OneSignal.push(['getNotificationPermission', function (permission) {
              var allow = false
              if(permission === 'granted'){
                allow = true
              }
              const res = httpGet('http://localhost:8005/api/register/'+ storeid + '/' + playerIdCurrent + '/' + allow)
              console.log('Add to FireStore : >>>>>>>>>>>>>>>>>>> ', res)
            }])
            } else {
              console.log('PlayerId == null && cannot add to firebase yet!!!!')
            }
          })
        })   
    }
    function httpGet (theUrl) {
      var xmlHttp = new XMLHttpRequest()
      xmlHttp.open('GET', theUrl, false)
      xmlHttp.send(null)
      return xmlHttp.responseText
    }
    </script>
    </head>
    <body>
      <div align='center'>
        <p id='demo'>PlayerId From Onesignal</p>
        <button id='register-button'  onclick='subscribe()' style='margin-right: 100px'>Register</button>
        <button id='register-button'  onclick='corn()' style='margin-right: 100px'>Corn</button>
      </div>
    </body>
</html>